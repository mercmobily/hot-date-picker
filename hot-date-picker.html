<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">

<!--
`hot-date-picker`
Minimal date picker

@demo demo/index.html
-->

<dom-module id="hot-date-picker">
  <template>
    <style>
      :host {
        display: block;
        margin-top: 20px;
        margin-bottom: 5px;
      }

      .container {
        @apply(--layout-flex-auto);
        @apply(--layout-relative);

        width: 100%;
        max-width: 100%;
      }

      label {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        width: 100%;
        font: inherit;
        color: var(--hot-date-picker-label-color, --secondary-text-color);
        -webkit-transition: -webkit-transform 0.25s, width 0.25s;
        transition: transform 0.25s, width 0.25s;
        -webkit-transform-origin: left top;
        transform-origin: left top;

        -webkit-transform: translateY(-25%) scale(0.75);
        transform: translateY(-25%) scale(0.75);
        width: 133%;

        @apply(--paper-font-common-nowrap);
        @apply(--paper-font-subhead);
      }

      .day, .month, .year {
        display: inline-block;
      }
      .day {
        width: 3em;
      }
      .month {
        width: 6em;
      }
      .year {
        width: 4em;
      }

    </style>

    <div class="container">
      <label>{{label}}<!-- -- <b>{{_labelExtra}}</b>--></label>


      <template is="dom-if" if="[[invalid]]">
        <div class="error">[[errorMessage]]</div>
      </template>


      <paper-input auto-validate id="day" maxlength="2" class="day" value="{{day}}" name="day" label="Day" allowed-pattern="\d" pattern="^\d\d?$" error-message="Invalid!"></paper-input>

      <paper-dropdown-menu id="month" value="[[month]]" class="month" name="month" label="Month">
        <paper-listbox id="monthListbox" class="dropdown-content" attr-for-selected="value" selected="{{month}}">
          <paper-item label="" value="">Pick</paper-item>
          <paper-item value="01">Jan</paper-item>
          <paper-item value="02">Feb</paper-item>
          <paper-item value="03">Mar</paper-item>
          <paper-item value="04">Apr</paper-item>
          <paper-item value="05">May</paper-item>
          <paper-item value="06">June</paper-item>
          <paper-item value="07">July</paper-item>
          <paper-item value="08">Aug</paper-item>
          <paper-item value="09">Sep</paper-item>
          <paper-item value="10">Oct</paper-item>
          <paper-item value="11">Nov</paper-item>
          <paper-item value="12">Dec</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>

      <paper-input id="year" id="year" maxlength="4" class="year" value="{{year}}" label="Year" error-message="Invalid!"></paper-input>
    </container>

  </template>

  <script>
    Polymer({

      is: 'hot-date-picker',

      properties: {


        day: {
          type: String,
        },
        month: {
          type: String,
        },
        year: {
          type: String,
        },

        invalid: {
          type: Boolean,
          default: false,
          observer: '_invalidChanged'
        },

      },

      behaviors: [
        Polymer.IronFormElementBehavior
      ],

      observers: [
        '_valueChanged(value)',
        '_dateChanged(day,month,year)',
      ],

      _oneFieldSet: function(){
        return !!( this.$.day.value || this.$.month.value || this.$.year.value );
      },

      ready: function(){

        //this._labelExtra= this.valueSetConfirmation;
        var el = this;

        this.$.year.inputElement.validate = function(){

          // Value is empty: invalid if main element is required or one field
          // is set
          if( this.value == '' ) {
            this.invalid = !!el.required || el._oneFieldSet();
            return !this.invalid;
          }


          // It must be 4 characters
          if( this.value.length != 4 ){
            this.invalid = true;
            return !this.invalid;
          }

          // All good
          this.invalid = false;
          return !this.invalid;
        };


        this.$.month.validate = function(){

          // Value will depend on selected month
          var value = el.$.monthListbox.selected;

          // Value is empty: invalid if main element is required or one field
          // is set
          if( !value || value == '' ){
            this.invalid = !!el.required || el._oneFieldSet();
            return !this.invalid;
          }

          this.invalid = false;
          return !this.invalid;
        };


        this.$.day.inputElement.validate = function(){

          // Value is empty: invalid if main element is required or one field
          // is set
          if( this.value == '' ){
            this.invalid = !!el.required || el._oneFieldSet();
            return !this.invalid;
          }

          var day = this.value;

          function numberOfDays(year, month) {
            var d = new Date(year, month, 0);
            return d.getDate();
          }

          // Day cannot be below 0 regardless
          if( day <= 0 ){
            this.invalid = true;
            return !this.invalid;
          }

          // Month could be
          var month = el.$.monthListbox.selected;

          // We we don't have the month, we will go with a standard "31"
          if( ! month ){
            if(  day > 31 ){
              this.invalid = true;
              return !this.invalid;
            }
          }

          // We have the month: doing "proper" validation, using a default
          // non-leap year if the year isn't available
          if( day > numberOfDays( el.year || 2001, month) ){
            this.invalid = true;
            return !this.invalid;
          }

          this.invalid = false;
          return !this.invalid;
        }
      },


      /*
       * Reflect changes to day, month or year back to the global element's value
       *
      */
      _dateChanged: function(){

        this._protectDayMonthYear = true;

        if( !this.day || !this.month || !this.year ){
          this.value = '';
        } else {
          var formattedDay = this.day.length == 1  ?  "0" + this.day : this.day;
          this.value = this.year + "-" + this.month + '-' + formattedDay;
        }

        this.validate();
        this._protectDayMonthYear = false;
      },

      /*
       * Reflect changes to value back to day, month and year
       *
      */
      _valueChanged: function( v ){
        var m;

        if( this._protectDayMonthYear ) return;

        if( v && v.match ){
          if( m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/m) ){
            this.day = m[ 3 ];
            this.month = m[ 2] ;
            this.year = m[ 1 ];
          }
        } else {
          this.day ='';
          this.month = '';
          this.year = '';
        }

        this.validate();
      },

      // If invalid is set to "true", it will artificially invalidate _all_ fields
      _invalidChanged: function(){
        if( this.invalid ){
          this.$.day.invalid = true;
          this.$.month.invalid = true;
          this.$.year.invalid = true;
        } else {
          this.$.day.invalid = false;
          this.$.month.invalid = false;
          this.$.year.invalid = false;
        }
      },

      /*
       * Validate function; validation is TOTALLY delegated to the
       * sub-elements. They will do all of work of checking if they should be
       * set (if the parent is required, or if at least ONE sibling is set)
      */
      validate: function(){

        this.$.day.validate();
        this.$.month.validate();
        this.$.year.validate();

        // It's set as invalid if any one of the fields is invalid
        this.invalid = this.$.day.invalid || this.$.month.invalid || this.$.year.invalid;
        return !this.invalid;
      }

    });
  </script>
</dom-module>
